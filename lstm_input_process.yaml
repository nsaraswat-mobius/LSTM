name: Process String Input
description: Processes a string input into a pickled object.
inputs:
  - {name: inp_string, type: String, description: 'The input string (e.g., "[[1,2,3]]") to be processed.'}
outputs:
  - {name: inp_pickle, type: Dataset}
implementation:
  container:
    image: python:3.9
    command:
      - sh
      - -c
      - |
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import json
        import pickle
        import os

        parser = argparse.ArgumentParser()
        parser.add_argument('--inp_string', type=str, required=True)
        parser.add_argument('--inp_pickle', type=str, required=True)
        args = parser.parse_args()

        # Robust parsing of input string (handle quoted JSON, Python lists)
        print(f"Raw input: {repr(args.inp_string)}")
        
        # Clean the input string
        raw_str = args.inp_string.strip()
        
        # Remove outer quotes if present
        if len(raw_str) >= 2 and ((raw_str[0] == '"' and raw_str[-1] == '"') or (raw_str[0] == "'" and raw_str[-1] == "'")):
            print("Removing outer quotes")
            raw_str = raw_str[1:-1]
        
        # Try JSON parsing first
        try:
            data = json.loads(raw_str)
            print("Parsed with json.loads")
        except json.JSONDecodeError as e:
            print(f"JSON parsing failed: {e}")
            # Try Python literal_eval for Python-style lists
            try:
                import ast
                data = ast.literal_eval(raw_str)
                print("Parsed with ast.literal_eval")
            except Exception as ast_e:
                print(f"literal_eval also failed: {ast_e}")
                print("Raw input causing error:")
                print(args.inp_string)
                raise e
        
        os.makedirs(os.path.dirname(args.inp_pickle), exist_ok=True)
        with open(args.inp_pickle, "wb") as f:
            pickle.dump(data, f)

        print(f"Processed and saved pickled data to {args.inp_pickle}")
    args:
      - --inp_string
      - {inputValue: inp_string}
      - --inp_pickle
      - {outputPath: inp_pickle}
