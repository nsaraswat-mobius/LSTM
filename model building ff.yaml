name: Initialize LSTM Model
description: Initializes the LSTM model with support for Traditional, CAFO, and Forward Forward methods.
inputs:
  - {name: config, type: String}
outputs:
  - {name: model, type: Model}
implementation:
  container:
    image: gurpreetgandhi/nesy-factory:v28
    command:
      - sh
      - -c
      - |
        exec "$0" "$@"
      - python3
      - -u
      - -c
      - |
        import argparse
        import json
        import os
        import pickle
        import sys
        
        from nesy_factory.RNNs import LSTM

        parser = argparse.ArgumentParser()
        parser.add_argument('--config', type=str, required=True)
        parser.add_argument('--model', type=str, required=True)
        args = parser.parse_args()

        config = json.loads(args.config)

        # Determine output dimension based on training method
        use_forward_forward = config.get('use_forward_forward', False)
        use_cafo = config.get('use_cafo', False)
        
        output_dim = config.get('output_dim', 2 if (use_forward_forward or use_cafo) else 1)

        model_config = {
            'input_dim': len(config['feature_columns']),
            'hidden_dim': config['hidden_dim'],
            'output_dim': output_dim,
            'num_layers': config['num_layers'],
            'dropout': config['dropout'],
            'optimizer': 'adam',
            'learning_rate': config['learning_rate'],
            'epochs': config['epochs'],
            'loss_function': config['loss_function']
        }
        
        # Add CAFO parameters
        if use_cafo:
            model_config['use_cafo'] = True
            model_config['cafo_blocks'] = config.get('cafo_blocks', config['num_layers'])
            model_config['epochs_per_block'] = config.get('epochs_per_block', 50)
            model_config['block_lr'] = config.get('block_lr', 0.001)
            model_config['task_type'] = config.get('task_type', 'sequence_to_one')
        
        # Add Forward Forward parameters
        if use_forward_forward:
            model_config['use_forward_forward'] = True
            model_config['ff_blocks'] = config.get('ff_blocks', 3)
            model_config['ff_threshold'] = config.get('ff_threshold', 2.0)
            model_config['ff_epochs_per_block'] = config.get('ff_epochs_per_block', 100)
            model_config['ff_lr'] = config.get('ff_lr', 0.03)

        model_obj = LSTM(model_config)

        os.makedirs(os.path.dirname(args.model), exist_ok=True)
        with open(args.model, "wb") as f:
            pickle.dump(model_obj, f)

        print(f"Saved LSTM model to {args.model}")
    args:
      - --config
      - {inputValue: config}
      - --model
      - {outputPath: model}
